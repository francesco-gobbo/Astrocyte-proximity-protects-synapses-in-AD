title: "R Analysis of Spine/Astrocyte data by Dr Francesco Gobbo (original code input by Tara Spires-Jones" output: html_notebook ---

Load libraries

```{r}

library(readr)
library(plyr)
library(forcats)
library(lme4)
library(ggplot2)
library(stargazer)
library(lmerTest)
library(rcompanion)
library(dplyr)
library(tidyverse)
library(emmeans)
library(reshape2)
library(tidyr)
library(qwraps2)
library(arsenal)
library(table1)
library(plotrix)
library(ggResidpanel)
library(lubridate)

```


```{r}
# set working directory
setwd("C:\\Users\\fr87_\\OneDrive - University of Edinburgh\\2023 - AD Project\\Paper\\2025 Gobbo et al\\R Analysis")
```

----------------
Data for Figure 1
----------------
Analysis of spine loss with AD BRAIN HOMOGENATE
----------------
```{r}
# import CSV
SpinelossData <- read.csv("Fig1Data_Spine_Loss.csv")

SpinelossData$Experiment <- as.factor(SpinelossData$Experiment)
SpinelossData$Animal_ID <- as.factor(SpinelossData$Animal_ID)
SpinelossData$Slice_ID <- as.factor(SpinelossData$Spine_ID)
SpinelossData$AbetaTreatment <- as.factor(SpinelossData$Abeta_Treatment)
SpinelossData$Survival_Probability <- SpinelossData$Survival_probability
SpinelossData$Sex <- as.factor(SpinelossData$Sex)
SpinelossData$Experiment_ID <- as.factor(SpinelossData$ID)
SpinelossData$Filler <- as.factor(SpinelossData$Filler)


SpinelossData2 <- SpinelossData 

SpinelossData2$AbetaTreatment <- recode(SpinelossData2$AbetaTreatment, 'Abeta+' = 'Ab+ homogenate',
                           'Abeta-'  = 'Ab- homogenate', 'ACSF'='ACSF')

summary(SpinelossData2) 
```


```{r}
SpinelossData2_animal <- SpinelossData2 %>%
  group_by(Animal_ID, AbetaTreatment,Sex) %>%
    summarize(  Percent_lost=mean(Percent_lost))


SurvivalViolinPlot <- ggplot(SpinelossData2, aes(y=Percent_lost, x=AbetaTreatment)) +
  geom_violin(draw_quantiles = c(0.25, 0.75),  linetype = "dashed") +  
  geom_violin(fill="transparent",draw_quantiles = 0.5) +
  geom_point(data = SpinelossData2, aes(x = AbetaTreatment, y = Percent_lost, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2,      size = 0.5) +
  geom_point(data = SpinelossData2_animal, aes(x = AbetaTreatment, y = Percent_lost, colour = Animal_ID,shape=Sex), position = position_jitter(w = 0.1, h =          0.0), alpha = 0.8, size = 2.5) +
  theme_classic(base_size = 14) + 
  xlab(NULL)  +
  theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
  ylab(expression(bold(paste("Spine calcium transient event rate (Hz)")))) +
  guides(colour = "none")   # removes group legend

SurvivalViolinPlot

ggsave(filename = "Survival_ViolinPlot.png",
       width = 8,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )

summary(SpinelossData2_animal) 
```
```{r}
sum(SpinelossData2$Stable_spines, na.rm = TRUE)+sum(SpinelossData2$Lost_spines, na.rm = TRUE)

```

```{r}
ME_lost <- lmer(Percent_lost ~ AbetaTreatment*Sex    +(1|Animal_ID/Slice_ID)+(1|Filler), data = SpinelossData2)

summary(ME_lost)
```
```{r}
resid_panel(ME_lost) # residuals look ok

anova(ME_lost)
```
```{r}
emmeans(ME_lost, list(pairwise ~ AbetaTreatment  ), adjust = "tukey") #

```


```{r}
ME_lost2 <- lmer(Percent_lost ~ AbetaTreatment  +(1|Animal_ID/Slice_ID)+(1|Filler), data = SpinelossData2)

summary(ME_lost2)
```
```{r}
resid_panel(ME_lost2) # residuals look ok

print(anova(ME_lost2))

emmeans(ME_lost2, list(pairwise ~ AbetaTreatment  ), adjust = "tukey") #

```

-------------------
Data for Fig 2
-------------------
GCFD positive neurons
-------------------
```{r}
# import CSV
Fig2Data <- read.csv("Fig2Data_ECFP_Expression_GCFD.csv")

Fig2Data$Slice <- as.factor(Fig2Data$Slice)
Fig2Data$Animal <- as.factor(Fig2Data$Animal)
Fig2Data$AstrocyteMarker <- as.factor(Fig2Data$AstrocyteMarker)
Fig2Data$Sex <- as.factor(Fig2Data$Sex)
levels(Fig2Data$AstrocyteMarker) <- c("GFAP", "S100\U03B2")




# histograms look fairly normal - take means
percent_IHCwECFP_histo <- ggplot(Fig2Data, aes(x = percent_IHCwECFP, fill = AstrocyteMarker)) + 
  geom_histogram()
percent_IHCwECFP_histo

percent_ECFP_withoutIHC_histo <- ggplot(Fig2Data, aes(x = percent_ECFP_withoutIHC, fill = AstrocyteMarker)) + 
  geom_histogram()
percent_ECFP_withoutIHC_histo

# summarize by animal for figures
Fig2Data_animal <- Fig2Data %>%
    group_by(Animal, AstrocyteMarker) %>%
    summarize(percent_IHCwECFP=mean(percent_IHCwECFP),
              percent_ECFP_withoutIHC=mean(percent_ECFP_withoutIHC),
              Sex =Sex[1])

# Plot the data 

Fig2Plot <- ggplot(data = Fig2Data, aes(x = AstrocyteMarker, y = percent_IHCwECFP)) +
                stat_boxplot(geom ='errorbar', width = 0.08, lwd = 0.5) +
                geom_boxplot (outlier.shape = NA, width = 0.50, lwd = 0.5) +
                geom_point(data = Fig2Data, aes(x = AstrocyteMarker, y = percent_IHCwECFP, colour = AstrocyteMarker), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 1) +
                geom_point(data = Fig2Data_animal, aes(x = AstrocyteMarker, y = percent_IHCwECFP, colour = AstrocyteMarker), position = position_jitter(w = 0., h =   0.0), alpha = 0.8, size = 2.5) +
                theme_classic(base_size = 14) + 
                 xlab(NULL)  +
                theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
                ylab(expression(bold(paste("percent IHC positive astrocytes filled with ECFP")))) +
                xlab(expression(bold(paste("IHC marker")))) +
                ylim(0,100)+
                guides(colour = "none")   # removes group legend
 Fig2Plot 

 

ggsave(filename = "Fig2Plot.png",
       width = 4,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )


Fig2Plot2 <- ggplot(data = Fig2Data, aes(x = AstrocyteMarker, y = percent_ECFP_withoutIHC)) +
                stat_boxplot(geom ='errorbar', width = 0.08, lwd = 0.5) +
                geom_boxplot (outlier.shape = NA, width = 0.50, lwd = 0.5) +
                geom_point(data = Fig2Data, aes(x = AstrocyteMarker, y = percent_ECFP_withoutIHC, colour = AstrocyteMarker), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 1) +
                geom_point(data = Fig2Data_animal, aes(x = AstrocyteMarker, y = percent_ECFP_withoutIHC, colour = AstrocyteMarker), position = position_jitter(w = 0., h =   0.0), alpha = 0.8, size = 2.5) +
                theme_classic(base_size = 14) + 
                 xlab(NULL)  +
                theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
                ylab(expression(bold(paste("percent ECFP filled cells negative for astrocyte IHC marker")))) +
                xlab(expression(bold(paste("IHC marker")))) +
                ylim(0,100)+
                guides(colour = "none")   # removes group legend
 Fig2Plot2 

 

ggsave(filename = "Fig2Plot2.png",
       width = 4,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )

####### test whether these are different from 100% or 0% respectively to test hypothesis that all astrocytes are filled with CFP and no astrocytes lack CFP labelling
Fig2Data_animal_GFAP <- Fig2Data_animal %>% 
  filter(AstrocyteMarker != "S100Î²") 

Fig2Data_animal_S100B <- Fig2Data_animal %>% 
  filter(AstrocyteMarker != "GFAP") 

t.test(Fig2Data_animal_GFAP$percent_ECFP_withoutIHC, alternative= "greater", mu=0) # no p value as all nice have 0 value - essentially p would be inf

t.test(Fig2Data_animal_GFAP$percent_IHCwECFP, alternative= "less", mu=100) # t = -3.2457, df = 3, p-value = 0.02382, adjusted p=0.09528

t.test(Fig2Data_animal_S100B$percent_ECFP_withoutIHC, alternative= "greater", mu=0) # t = 2.5105, df = 3, p-value = 0.04345, adjusted p=0.13035 

t.test(Fig2Data_animal_S100B$percent_IHCwECFP, alternative= "less", mu=100) #t = -1.8395, df = 3, p-value = 0.08156, adjusted p=0.16312 

# Holm adjust p values for multiple comparisons (results added above)

p <- c(0.02382,  0.04345, 0.08156)

padj <- p.adjust(p, method=p.adjust.methods, n=4)
p.adjust.methods # c("holm", "hochberg", "bonferroni","none")
padj




```

-----------------
Data for Fig. 3
-----------------
Activity in Hz between ABETA BRAIN HOMOGENATE and immunodepleted
-----------------

```{r}
# set working directory

# import CSV
SpineData <- read.csv("Fig3Data_Activity_change_GCFD_time_sex.csv")

SpineData$Exp_Date2 <- ymd(SpineData$Exp_Date)
SpineData$Animal_ID <- as.factor(SpineData$Animal_ID)
SpineData$Slice_ID <- as.factor(SpineData$Slice_ID)
SpineData$AbetaTreatment <- as.factor(SpineData$Abeta)
SpineData$Astrocyte_contact <- as.factor(SpineData$Astrocyte_contact)
SpineData$Survived_day2 <- as.factor(SpineData$Survived_day2)
SpineData$Time<- as.factor(SpineData$Time)
SpineData$EventRateHz <- SpineData$Hz
SpineData$Sex <- as.factor(SpineData$Sex)
SpineData$TreatmentTime <- as.factor(SpineData$Time)

SpineData2 <- SpineData %>%
  mutate(TreatmentTime = fct_relevel(TreatmentTime, 
            "PRE","POST"))

SpineData2 <- SpineData2 %>%
  mutate(Survived_day2 = fct_relevel(Survived_day2, 
            "Y","N"))


SpineData2$AbetaTreatment <- recode(SpineData2$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SpineData2$Astrocyte_contact <- recode(SpineData2$Astrocyte_contact, 'Y' = 'astrocyte contact',
                           'N'  = 'no astrocyte')

SpineData2$Survived_day2 <- recode(SpineData2$Survived_day2, 'Y' = 'survived',
                           'N'  = 'eliminated')

SpineData2$Spine_ID <- paste(SpineData2$Slice_ID, SpineData2$AbetaTreatment, SpineData2$ROI)
SpineData2$Spine_ID <- as.factor(SpineData2$Spine_ID)

```

```{r}
SpineData2_animal <- SpineData2 %>%
  group_by(Animal_ID, AbetaTreatment, TreatmentTime, Sex) %>%
    summarize(          EventRateHz=mean(EventRateHz))
```

```{r}
EventRateAbPrePostViolinPlot <- ggplot(SpineData2, aes(TreatmentTime, EventRateHz)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
geom_violin(fill="transparent",draw_quantiles = 0.5) +
  geom_point(data = SpineData2, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpineData2_animal, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID,shape=Sex), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.8, size = 2.5) +
  theme_classic(base_size = 14) + 
  xlab(NULL)  +
  theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
  ylab(expression(bold(paste("Spine calcium transient event rate (Hz)")))) +
  guides(colour = "none") +  # removes group legend
  facet_wrap(~AbetaTreatment)
 EventRateAbPrePostViolinPlot 

ggsave(filename = "EventRateAbPrePostViolinPlot.png",
       width = 8,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )

```
```{r}
ME_EventRateHz_sex <- lmer(EventRateHz ~ TreatmentTime*AbetaTreatment*Sex  +(1|Animal_ID/Slice_ID), data = SpineData2)

summary(ME_EventRateHz_sex)
```
```{r}
anova(ME_EventRateHz_sex)

resid_panel(ME_EventRateHz_sex) # residuals look ok-ish
```
```{r}
emmeans(ME_EventRateHz_sex, list(pairwise ~ TreatmentTime | AbetaTreatment), adjust = "tukey") #

```
```{r}
SpineData2$EventRateHzChangeTuk <- transformTukey(SpineData2$EventRateHz)

ME_EventRateHz_Tukey_sex <- lmer(EventRateHzChangeTuk ~ TreatmentTime*AbetaTreatment*Sex  +(1|Animal_ID/Slice_ID), data = SpineData2)

summary(ME_EventRateHz_Tukey_sex)

resid_panel(ME_EventRateHz_Tukey_sex) # residuals look ok-ish

```
```{r}
anova(ME_EventRateHz_Tukey_sex)

```
```{r}
emmeans(ME_EventRateHz_Tukey_sex, list(pairwise ~ TreatmentTime | AbetaTreatment), adjust = "tukey") #

```


```{r}
ME_EventRateHz <- lmer(EventRateHz ~ TreatmentTime*AbetaTreatment  +(1|Animal_ID/Slice_ID), data = SpineData2)

summary(ME_EventRateHz)

resid_panel(ME_EventRateHz) # residuals look ok-ish


```

```{r}
anova(ME_EventRateHz)

emmeans(ME_EventRateHz, list(pairwise ~ TreatmentTime | AbetaTreatment), adjust = "tukey") #
```

-------------
Change in activity by Survival
-------------


```{r}

# import CSV
SpineAstroData <- read.csv("Fig3Data_GCFD_del_Hz_Hz_sex.csv")

SpineAstroData$Exp_Date2 <- ymd(SpineAstroData$Exp_Date)
SpineAstroData$Animal_ID <- as.factor(SpineAstroData$Animal_ID)
SpineAstroData$Slice_ID <- as.factor(SpineAstroData$Slice_ID)
SpineAstroData$AbetaTreatment <- as.factor(SpineAstroData$Abeta)
SpineAstroData$Astrocyte_contact <- as.factor(SpineAstroData$Astrocyte_contact)
SpineAstroData$Survived_day2 <- as.factor(SpineAstroData$Survived_day2)
SpineAstroData$Del_Hz_Over_Hz<- as.factor(SpineAstroData$del_Hz_over_Hz)
SpineAstroData$EventRateHz <- SpineAstroData$Hz
SpineAstroData$Sex <- as.factor(SpineAstroData$Sex)

SpineAstroData2 <- SpineAstroData %>%
  mutate(Survived_day2 = fct_relevel(Survived_day2, 
            "Y","N"))


SpineAstroData2$AbetaTreatment <- recode(SpineAstroData2$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SpineAstroData2$Astrocyte_contact <- recode(SpineAstroData2$Astrocyte_contact, 'Y' = 'astrocyte contact',
                           'N'  = 'no astrocyte')

SpineAstroData2$Survived_day2 <- recode(SpineAstroData2$Survived_day2, 'Y' = 'survived',
                           'N'  = 'eliminated')

SpineAstroData2$Spine_ID <- paste(SpineAstroData$Slice_ID, SpineAstroData$AbetaTreatment, SpineAstroData$ROI)

SpineAstroData3 <- SpineAstroData2

SpineAstroData3$DelHzOverHz_ActivityChange <-(SpineAstroData3$POST_Hz_AVG- SpineAstroData3$PRE_Hz_AVG)/SpineAstroData3$PRE_Hz_AVG

SpineAstroData3 <-SpineAstroData3[!is.infinite(SpineAstroData3$DelHzOverHz_ActivityChange), ]

SpineAstroData3_animal <- SpineAstroData3 %>%
    group_by(Animal_ID, AbetaTreatment) %>%
    summarize(DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))


```

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

```{r}
# remove rows without astrocyte data
SpineAstroData4 <- SpineAstroData3[SpineAstroData3$Astrocyte_contact != "", ]
SpineAstroData4_animal <- SpineAstroData4 %>%
    group_by(Animal_ID, AbetaTreatment) %>%
    summarize(              DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))

```

Plots for Delta Hz over Hz

```{r}
library(RColorBrewer)

SpineAstroData4_animal_survival <- SpineAstroData4 %>%
    group_by(Animal_ID, AbetaTreatment, Survived_day2, Sex) %>%
    summarize(DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))

color_values <- c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD", "#8C564B", "#E377C2", 
  "#7F7F7F", "#BCBD22", "#17BECF", "#AEC7E8", "#FFBB78", "#98DF8A", "#FF9896", 
  "#C5B0D5", "#C49C94", "#F7B6D2", "#9EDAE5")

DelHzOverHz_ACtivityChangeViolinPlotSurv <- ggplot(SpineAstroData4, aes(x= Survived_day2, y=DelHzOverHz_ActivityChange)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SpineAstroData4, aes(x = Survived_day2, y = DelHzOverHz_ActivityChange, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpineAstroData4_animal_survival, aes(x = Survived_day2, y = DelHzOverHz_ActivityChange, colour = Animal_ID, shape=Sex), position = position_jitter(w = 0.3, h =   0.0), alpha = 0.8, size = 2.5, stroke=1)+ scale_color_manual(values=color_values)+
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Spine calcium transient change 2h 
  post-treatment (Del Hz post / Hz )")))) +
  guides(colour = "none") +
  facet_wrap(~AbetaTreatment)
 DelHzOverHz_ACtivityChangeViolinPlotSurv 
 
  ggsave(filename = "DelHzOverHz_ACtivityChangeViolinPlotSurv.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
```

```{r}
ME_DelHzOverHz_ActivityChange_sex <- lmer(DelHzOverHz_ActivityChange ~ AbetaTreatment  + Sex + (1|Animal_ID/Slice_ID), data = SpineAstroData3)

summary(ME_DelHzOverHz_ActivityChange_sex)
```

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

```{r}
resid_panel(ME_DelHzOverHz_ActivityChange_sex) # residuals look ok

```

```{r}
shapiro.test(resid(ME_DelHzOverHz_ActivityChange_sex)) # don't meet assumptions W = 0.55162, p-value < 2.2e-16
```

```{r}
anova(ME_DelHzOverHz_ActivityChange_sex)
```

```{r}
ME_DelHzOverHz_ActivityChange_persex <- lmer(DelHzOverHz_ActivityChange ~ AbetaTreatment*Sex + (1|Animal_ID/Slice_ID), data = SpineAstroData3)

summary(ME_DelHzOverHz_ActivityChange_persex)
```


```{r}
ME_DelHzOverHz_ActivityChange_Survival_sex <- lmer(DelHzOverHz_ActivityChange ~ AbetaTreatment*Survived_day2*Sex + (1|Animal_ID/Slice_ID), data = SpineAstroData4)
anova(ME_DelHzOverHz_ActivityChange_Survival_sex)
summary(ME_DelHzOverHz_ActivityChange_Survival_sex)
resid_panel(ME_DelHzOverHz_ActivityChange_Survival_sex)
```
```{r}
emmeans(ME_DelHzOverHz_ActivityChange_Survival_sex, list(pairwise ~ Survived_day2 | AbetaTreatment), adjust = "tukey") #

```


```{r}
SpineAstroData4$DelHzOverHz_ActivityChangeTuk <- transformTukey(SpineAstroData4$DelHzOverHz_ActivityChange)

ME_DelHzOverHz_ActivityChange_Tukey_sex <- lmer(DelHzOverHz_ActivityChangeTuk ~ Survived_day2*AbetaTreatment*Sex +(1|Animal_ID/Slice_ID), data = SpineAstroData4)

summary(ME_DelHzOverHz_ActivityChange_Tukey_sex)
resid_panel(ME_DelHzOverHz_ActivityChange_Tukey_sex)
```

```{r}
anova(ME_DelHzOverHz_ActivityChange_Tukey_sex)
```

```{r}
emmeans(ME_DelHzOverHz_ActivityChange_Tukey_sex, list(pairwise ~ Survived_day2 | AbetaTreatment), adjust = "tukey") #
```
```{r}
ME_DelHzOverHz_ActivityChange_Tukey<- lmer(DelHzOverHz_ActivityChangeTuk ~ Survived_day2*AbetaTreatment +(1|Animal_ID/Slice_ID), data = SpineAstroData4)

summary(ME_DelHzOverHz_ActivityChange_Tukey)
resid_panel(ME_DelHzOverHz_ActivityChange_Tukey)
```
```{r}
anova(ME_DelHzOverHz_ActivityChange_Tukey)
```
```{r}
emmeans(ME_DelHzOverHz_ActivityChange_Tukey, list(pairwise ~ Survived_day2 | AbetaTreatment), adjust = "tukey") #
```

-------------
Change in activity by astrocyte proximity
-------------

```{r}

SpineAstroData4_animal_astro <- SpineAstroData4 %>%
    group_by(Animal_ID, AbetaTreatment, Astrocyte_contact, Sex) %>%
    summarize(          DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))


DelHzOverHz_ACtivityChangeViolinPlotAstro <- ggplot(SpineAstroData4, aes(x=AbetaTreatment, y=DelHzOverHz_ActivityChange)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SpineAstroData4, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpineAstroData4_animal_astro, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID, shape=Sex), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Spine calcium transient change 2h 
  post-treatment (Del Hz  / Hz )")))) +
  guides(colour = "none") +
  facet_wrap(~Astrocyte_contact)
 DelHzOverHz_ACtivityChangeViolinPlotAstro 
 
  ggsave(filename = "DelHzOverHz_ACtivityChangeViolinPlotAstro.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
```

```{r}
ME_DelHzOverHz_ActivityChangeAstro <- lmer(DelHzOverHz_ActivityChange ~ Astrocyte_contact*AbetaTreatment  +(1|Animal_ID/Slice_ID), data = SpineAstroData4)

summary(ME_DelHzOverHz_ActivityChangeAstro)
```

```{r}
anova(ME_DelHzOverHz_ActivityChangeAstro)

```
```{r}
emmeans(ME_DelHzOverHz_ActivityChangeAstro, list(pairwise ~  AbetaTreatment | Astrocyte_contact), adjust = "tukey") #

```

----------------
Data for Fig.4
----------------
Spine Survival by astrocyte proximity
----------------
```{r}
# import CSV
SurvivalData <- read.csv("Fig4Data_Survival_Probability_sex.csv")

SurvivalData$Exp_Date2 <- ymd(SurvivalData$Exp_Date)
SurvivalData$Animal_ID <- as.factor(SurvivalData$Animal_ID)
SurvivalData$Slice_ID <- as.factor(SurvivalData$Slice_ID)
SurvivalData$AbetaTreatment <- as.factor(SurvivalData$Abeta)
SurvivalData$Astrocyte_contact <- as.factor(SurvivalData$Astrocyte_contact)
SurvivalData$Survival_Probability <- SurvivalData$Survival_probability
SurvivalData$Sex <- as.factor(SurvivalData$Sex)


SurvivalData2 <- SurvivalData 

SurvivalData2$AbetaTreatment <- recode(SurvivalData2$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SurvivalData2$Astrocyte_contact <- recode(SurvivalData2$Astrocyte_contact, 'Y' = 'astrocyte contact',
                           'N'  = 'no astrocyte')

SurvivalData2$Spine_ID <- paste(SurvivalData2$Slice_ID, SurvivalData2$AbetaTreatment, SurvivalData2$ROI)
SurvivalData2$Spine_ID <- as.factor(SurvivalData2$Spine_ID)

```

```{r}
SurvivalData2_animal <- SurvivalData2 %>%
  group_by(Animal_ID, AbetaTreatment, Astrocyte_contact,Sex) %>%
    summarize(          Survival_Probability=mean(Survival_Probability))
```

```{r}
SurvivalViolinPlot <- ggplot(SurvivalData2, aes(y=Survival_Probability, x=Astrocyte_contact)) +
  geom_violin(draw_quantiles = c(0.25, 0.75),  linetype = "dashed") +  
  geom_violin(fill="transparent",draw_quantiles = 0.5) +
  geom_point(data = SurvivalData2, aes(x = Astrocyte_contact, y = Survival_Probability, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2,      size = 0.5) +
  geom_point(data = SurvivalData2_animal, aes(x = Astrocyte_contact, y = Survival_Probability, colour = Animal_ID,shape=Sex), position = position_jitter(w = 0.1, h =          0.0), alpha = 0.8, size = 2.5) +
  theme_classic(base_size = 14) + 
  xlab(NULL)  +
  theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
  ylab(expression(bold(paste("Spine calcium transient event rate (Hz)")))) +
  guides(colour = "none") +  # removes group legend
  facet_wrap(~AbetaTreatment)

SurvivalViolinPlot

ggsave(filename = "Survival_ViolinPlot.png",
       width = 8,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
```

```{r}
ME_Survival <- lmer(Survival_Probability ~ Astrocyte_contact*AbetaTreatment*Sex  +(1|Animal_ID/Slice_ID), data = SurvivalData2)

summary(ME_Survival)
```
```{r}
anova(ME_Survival)
resid_panel(ME_Survival)
```
```{r}
emmeans(ME_Survival, list(pairwise ~ Astrocyte_contact | AbetaTreatment), adjust = "tukey") 
```


```{r}
ME_Survival <- lmer(Survival_Probability ~ Astrocyte_contact*AbetaTreatment  +(1|Animal_ID/Slice_ID), data = SurvivalData2)

summary(ME_Survival)
```
```{r}
print(anova(ME_Survival))

emmeans(ME_Survival, list(pairwise ~ Astrocyte_contact | AbetaTreatment ), adjust = "tukey") #


```

----------------
Data for Fig. S5
----------------
Activity change in WT slices with AD BRAIN HOMOGENATE
----------------
```{r}
# import CSV
WTData <- read.csv("FigS5Data_WT_activity_long.csv")

WTData$Animal_ID <- as.factor(WTData$Animal_ID)
WTData$Slice_ID <- as.factor(WTData$Slice_ID)

WTData$Sex <- as.factor(WTData$Sex)

WTData$EventRateHz <- WTData$Hz

WTData$TreatmentTime <- as.factor(WTData$Time)

WTData2 <- WTData # removes NaNs

WTData2_animal <- WTData2 %>%
    group_by(Animal_ID, TreatmentTime) %>%
    summarize(EventRateHz=mean(EventRateHz))
```
```{r}
EventRateAbPrePostViolinPlotwt <- ggplot(WTData2, aes(TreatmentTime, EventRateHz)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
geom_violin(fill="transparent",draw_quantiles = 0.5) +
  geom_point(data = WTData2, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = WTData2_animal, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.8, size = 2.5) +
  theme_classic(base_size = 14) + 
  xlab(NULL)  +
  theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
  ylab(expression(bold(paste("Spine calcium transient event rate (Hz)")))) +
  guides(colour = "none")  # removes group legend

 EventRateAbPrePostViolinPlotwt

```
```{r}
 
ME_EventRateHzwt <- lmer(EventRateHz ~ TreatmentTime+Sex
                    +(1|Animal_ID/Slice_ID), data = WTData2)

summary(ME_EventRateHzwt)
resid_panel(ME_EventRateHzwt)
anova(ME_EventRateHzwt)
emmeans(ME_EventRateHzwt, pairwise ~ TreatmentTime , adjust = "tukey")
```

----------------
Survival by Genotype
----------------

```{r}

# import CSV
SurvDataWT <- read.csv("FigS5Data_Survival_probability_GCFD_vs_WT.csv")

# assign factors to relevant variables and make exp date a real date

SurvDataWT$Animal_ID <- as.factor(SurvDataWT$Animal_ID)
SurvDataWT$Slice_ID <- as.factor(SurvDataWT$Slice_ID)
SurvDataWT$Genotype <- as.factor(SurvDataWT$Genotype)
SurvDataWT$Survival_probability <- as.numeric(SurvDataWT$Survival_probability)

SurvDataWT_animal <- SurvDataWT %>%
    group_by(Animal_ID, Genotype) %>%
    summarize(Survival_probability=mean(Survival_probability))
```
```{r}

SurvViolinPlotSurvWT <- ggplot(SurvDataWT, aes(x= Genotype, y=Survival_probability)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SurvDataWT, aes(x = Genotype, y = Survival_probability, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SurvDataWT_animal, aes(x = Genotype, y = Survival_probability, colour = Animal_ID), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Percent survived spines")))) +
  guides(colour = "none") 

SurvViolinPlotSurvWT 
 
  ggsave(filename = "SurvPlotAstroPsVueExp.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )

  
ME_SurvWT <- lmer(Survival_probability ~ Genotype+Sex +(1|Animal_ID), data = SurvDataWT)
summary(ME_SurvWT)
resid_panel(ME_SurvWT) # residuals look ok
shapiro.test(resid(ME_SurvWT)) # don't meet assumptions W = 0.96089, p-value < 2.2e-16
anova(ME_SurvWT)
emmeans(ME_SurvWT, list(pairwise ~ Genotype), adjust = "tukey") #
```

----------------
Data for Fig. S7
----------------
Analysis of spine activity with AD BRAIN HOMOGENATE at 24h
----------------
```{r}
# import CSV
Spine24Data <- read.csv("FigS7Data_long_PRE_POST_24h.csv")

Spine24Data$Animal_ID <- as.factor(Spine24Data$Animal_ID)
Spine24Data$Slice_ID <- as.factor(Spine24Data$Slice_ID)
Spine24Data$AbetaTreatment <- as.factor(Spine24Data$Abeta)

Spine24Data$Sex <- as.factor(Spine24Data$Sex)

Spine24Data$EventRateHz <- Spine24Data$Hz

Spine24Data$TreatmentTime <- as.factor(Spine24Data$Time)

Spine24Data$AbetaTreatment <- recode(Spine24Data$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

Spine24Data$Astrocyte_contact <- recode(Spine24Data$Astrocyte_contact, 'Y' = 'Astrocyte contact',
                           'N'  = 'No astrocyte contact')

Spine24Data2 <- na.omit(Spine24Data) # removes NaNs

Spine24Data2_animal <- Spine24Data2 %>%
    group_by(Animal_ID, AbetaTreatment, Astrocyte_contact, TreatmentTime) %>%
    summarize(EventRateHz=mean(EventRateHz))
```
```{r}
EventRateAbPrePostViolinPlot <- ggplot(Spine24Data2, aes(TreatmentTime, EventRateHz)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
geom_violin(fill="transparent",draw_quantiles = 0.5) +
  geom_point(data = Spine24Data2, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = Spine24Data2_animal, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.8, size = 2.5) +
  theme_classic(base_size = 14) + 
  xlab(NULL)  +
  theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
  ylab(expression(bold(paste("Spine calcium transient event rate (Hz)")))) +
  guides(colour = "none") +  # removes group legend
  facet_wrap(~ (AbetaTreatment), labeller = label_value, nrow=1)+theme(strip.text = element_text(size = 8))

 EventRateAbPrePostViolinPlot 

``` 
```{r}
 
ME_EventRateHz <- lmer(EventRateHz ~ TreatmentTime*AbetaTreatment+Sex
                    +(1|Animal_ID/Slice_ID), data = Spine24Data2)

summary(ME_EventRateHz)
resid_panel(ME_EventRateHz)
anova(ME_EventRateHz)
emmeans(ME_EventRateHz, pairwise ~ TreatmentTime | AbetaTreatment, adjust = "tukey")
emmeans(ME_EventRateHz, pairwise ~ TreatmentTime , by = "AbetaTreatment", adjust = "tukey")
```

-------------
Change in activity 
-------------

```{r}
# import CSV
Spine24Data3 <- read.csv("FigS7Data_Activity_Change_24h.csv")

Spine24Data3$Animal_ID <- as.factor(Spine24Data3$Animal_ID)
Spine24Data3$Slice_ID <- as.factor(Spine24Data3$Slice_ID)
Spine24Data3$AbetaTreatment <- as.factor(Spine24Data3$Abeta)

Spine24Data3$Sex <- as.factor(Spine24Data3$Sex)

Spine24Data3$DelHzOverHz_ActivityChange <- Spine24Data3$DelHz_over_Hz

Spine24Data3$AbetaTreatment <- recode(Spine24Data3$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

Spine24Data3$Astrocyte_contact <- recode(Spine24Data3$Astrocyte_contact, 'Y' = 'Astrocyte contact',
                           'N'  = 'No astrocyte contact')

Spine24Data4 <- na.omit(Spine24Data3) # removes NaNs
Spine24Data4 <- Spine24Data4[
                                   !is.na(Spine24Data4$Astrocyte_contact) & Spine24Data4$Astrocyte_contact != "" &
                                    is.finite(Spine24Data4$DelHzOverHz_ActivityChange) & !is.na(Spine24Data4$DelHzOverHz_ActivityChange), ]


Spine24Data4_animal <- Spine24Data4 %>%
    group_by(Animal_ID, AbetaTreatment) %>%
    summarize(              DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))

```

```{r}
library(RColorBrewer)

Spine24Data4_animal_survival <- Spine24Data4 %>%
    group_by(Animal_ID, AbetaTreatment, Sex) %>%
    summarize(DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))

color_values <- c("#1F77B4", "#FF7F0E", "#2CA02C", "#D62728", "#9467BD",
  "#8C564B", "#E377C2", "#7F7F7F", "#BCBD22", "#17BECF",
  "#AEC7E8", "#FFBB78", "#98DF8A", "#FF9896", "#C5B0D5",
  "#C49C94", "#F7B6D2", "#9EDAE5", "#393B79", "#637939",
  "#8C6D31", "#843C39", "#7B4173", "#17BECF", "#9C9EDE", "#9C1EDE")

DelHzOverHz_ACtivityChangeViolinPlotSurv <- ggplot(Spine24Data4, aes(x= AbetaTreatment, y=DelHzOverHz_ActivityChange)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = Spine24Data4, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = Spine24Data4_animal_survival, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID, shape=Sex), position = position_jitter(w = 0.3, h =   0.0), alpha = 0.8, size = 2.5, stroke=1)+ scale_color_manual(values=color_values)+
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Spine calcium transient change 2h 
  post-treatment (Del Hz post / Hz )")))) +
  guides(colour = "none") 
 DelHzOverHz_ACtivityChangeViolinPlotSurv 
 

```

```{r}
ME_DelHzOverHz_ActivityChange24 <- lmer(DelHzOverHz_ActivityChange ~ AbetaTreatment*Sex + (1|Animal_ID/Slice_ID), data = Spine24Data4)

summary(ME_DelHzOverHz_ActivityChange24)

resid_panel(ME_DelHzOverHz_ActivityChange24) # residuals look ok

shapiro.test(resid(ME_DelHzOverHz_ActivityChange24)) # don't meet assumptions W = 0.55162, p-value < 2.2e-16

anova(ME_DelHzOverHz_ActivityChange24)
```

```{r}
ME_DelHzOverHz_ActivityChange_sex24 <- lmer(DelHzOverHz_ActivityChange ~ AbetaTreatment + Sex + (1|Animal_ID/Slice_ID), data = Spine24Data4)
anova(ME_DelHzOverHz_ActivityChange_sex24)
summary(ME_DelHzOverHz_ActivityChange_sex24)
resid_panel(ME_DelHzOverHz_ActivityChange_sex24)
emmeans(ME_DelHzOverHz_ActivityChange_sex24, list(pairwise ~  AbetaTreatment), adjust = "tukey") #

```


```{r}
Spine24Data4$DelHzOverHz_ActivityChangeTuk <- transformTukey(Spine24Data4$DelHzOverHz_ActivityChange)

ME_DelHzOverHz_ActivityChange_Tukey_sex24 <- lmer(DelHzOverHz_ActivityChangeTuk ~ AbetaTreatment+Sex +(1|Animal_ID/Slice_ID), data = Spine24Data4)

summary(ME_DelHzOverHz_ActivityChange_Tukey_sex24)
resid_panel(ME_DelHzOverHz_ActivityChange_Tukey_sex24)

anova(ME_DelHzOverHz_ActivityChange_Tukey_sex24)
```


-------------
Change in activity by astrocyte
-------------

```{r}

Spine24Data4_animal_astro <- Spine24Data4 %>%
    group_by(Animal_ID, AbetaTreatment, Astrocyte_contact, Sex) %>%
    summarize(          DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))


DelHzOverHz_ACtivityChangeViolinPlotAstro24 <- ggplot(Spine24Data4, aes(x=AbetaTreatment, y=DelHzOverHz_ActivityChange)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = Spine24Data4, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = Spine24Data4_animal_astro, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID, shape=Sex), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Spine calcium transient change 2h 
  post-treatment (Del Hz  / Hz )")))) +
  guides(colour = "none") +
  facet_wrap(~ ( Astrocyte_contact), labeller =  label_value, nrow=1)+theme(strip.text = element_text(size = 8))
 DelHzOverHz_ACtivityChangeViolinPlotAstro24
```

```{r}
ME_DelHzOverHz_ActivityChangeAstroTuk24 <- lmer(DelHzOverHz_ActivityChangeTuk ~ Astrocyte_contact*AbetaTreatment +Sex  +(1|Animal_ID/Slice_ID), data = Spine24Data4)

summary(ME_DelHzOverHz_ActivityChangeAstroTuk24)

anova(ME_DelHzOverHz_ActivityChangeAstroTuk24)

emmeans(ME_DelHzOverHz_ActivityChangeAstroTuk24, list(pairwise ~  AbetaTreatment | Astrocyte_contact),  adjust = "tukey") #

```

----------------
Data for Fig. S9
----------------
Astrocyte number per field
----------------

```{r}
# import CSV
AstroData <- read.csv("FigS9Data_Astrocytes_per_field.csv")

AstroData$Animal_ID <- as.factor(AstroData$Animal_ID)
AstroData$Slice_ID <- as.factor(AstroData$Slice_ID)
AstroData$AbetaTreatment <- as.factor(AstroData$Abeta)

AstroData$Sex <- as.factor(AstroData$Sex)

AstroData$N_Astrocytes <- AstroData$N_Astrocytes


AstroData$AbetaTreatment <- recode(AstroData$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

AstroData2 <- na.omit(AstroData) # removes NaNs

ME_Astro <- lmer(N_Astrocytes ~ AbetaTreatment + Sex + (1|Animal_ID), data = AstroData2)
anova(ME_Astro)
summary(ME_Astro)
resid_panel(ME_Astro)
anova(ME_Astro)

```

----------------
Data for Fig.5
----------------
PsVue changes analysis
----------------

```{r}

# import CSV
SpinePsVueData <- read.csv("Fig5Data_PsVue_changes.csv")

# assign factors to relevant variables and make exp date a real date

SpinePsVueData$Exp_Date2 <- ymd(SpinePsVueData$Exp_Date)
SpinePsVueData$Animal_ID <- as.factor(SpinePsVueData$Animal_ID)
SpinePsVueData$Slice_ID <- as.factor(SpinePsVueData$Slice_ID)
SpinePsVueData$AbetaTreatment <- as.factor(SpinePsVueData$Abeta)
SpinePsVueData$Astrocyte_contact <- as.factor(SpinePsVueData$Astrocyte_contact)
SpinePsVueData$Survived_day2 <- as.factor(SpinePsVueData$Survived_at_24h)
SpinePsVueData$DelPsVue_PsVue <- as.numeric(SpinePsVueData$DelPsVue_Pre)
SpinePsVueData$DelPsVue <- as.numeric(SpinePsVueData$DelPsVue)
SpinePsVueData$BH_Batch <- as.factor(SpinePsVueData$Brain_homogenate)




SpinePsVueData2 <- SpinePsVueData %>%
  mutate(Survived_day2 = fct_relevel(Survived_day2, 
            "Y","N"))


SpinePsVueData$AbetaTreatment <- recode(SpinePsVueData$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SpinePsVueData$Astrocyte_contact <- recode(SpinePsVueData$Astrocyte_contact, 'Y' = 'astrocyte contact',
                           'N'  = 'no astrocyte')

SpinePsVueData$Survived_day2 <- recode(SpinePsVueData$Survived_day2, 'Y' = 'survived',
                           'N'  = 'eliminated')

SpinePsVueData$Spine_ID <- paste(SpinePsVueData$Slice_ID, SpinePsVueData$AbetaTreatment, SpinePsVueData$ROI)
SpinePsVueData$Spine_ID <- as.factor(SpinePsVueData$Spine_ID)

SpinePsVueData2 <- SpinePsVueData
SpinePsVueData2$Exp_Date <- NULL
SpinePsVueData2$Abeta <- NULL
SpinePsVueData2$ROI <- NULL
SpinePsVueData2$Hz <- NULL
SpinePsVueData2$Time <- NULL
SpinePsVueData2$Exp_Date2 <- NULL

# remove rows without astrocyte data
SpinePsVueData2 <- SpinePsVueData2[SpinePsVueData2$Astrocyte_contact != "", ]

# get summary of event rate and change in event rate by animal
SpinePsVueData_animal <- SpinePsVueData2 %>%
    group_by(Animal_ID, AbetaTreatment) %>%
    summarize(DelPsVue_PsVue=mean(DelPsVue_PsVue))

SpinePsVueData_animal_astro <- SpinePsVueData2 %>%
    group_by(Animal_ID, AbetaTreatment, Astrocyte_contact) %>%
    summarize(DelPsVue_PsVue=mean(DelPsVue_PsVue))

SpinePsVueData_animal_survival <- SpinePsVueData2 %>%
    group_by(Animal_ID, AbetaTreatment, Survived_day2) %>%
    summarize(DelPsVue_PsVue=mean(DelPsVue_PsVue))

```
Plot PtSer change and analyse

```{r}

DelPsVue_PsVue_ViolinPlot <- ggplot(SpinePsVueData2, aes(AbetaTreatment, DelPsVue_PsVue)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SpinePsVueData_animal, aes(x = AbetaTreatment, y = DelPsVue_PsVue, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  #geom_line(data = SpineAstroData3_animal, aes(x = AbetaTreatment, y = ActivityChange, group = Animal_ID, colour = Animal_ID), 
   #         position = position_jitter(w = 0.0, h = 0.0), size = 0.7) +  # Add lines connecting points for each animal
  theme_classic(base_size = 14) + 
#  ylim(0,5)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("PtSer change 2h 
  post-treatment (Del PsVue / PsVue )")))) +
  guides(colour = "none")  # removes group legend
  
 print(DelPsVue_PsVue_ViolinPlot)
 
 ggsave(filename = "DelPsVue_PsVue_ViolinPlot.png",
       width = 6,
       height = 8,
       dpi = 600,
       limitsize = FALSE
       )

```

```{r}
SpinePsVueData2$DelPsVue_PsVue_Tuk <- transformTukey(SpinePsVueData2$DelPsVue_PsVue)
ME_DelPsVue_PsVue_Tuk <- lmer(DelPsVue_PsVue_Tuk ~ AbetaTreatment*Sex+Brain_homogenate+(1|Animal_ID/Slice_ID), data = SpinePsVueData2)

summary(ME_DelPsVue_PsVue_Tuk)

resid_panel(ME_DelPsVue_PsVue_Tuk) # residuals look ok
shapiro.test(resid(ME_DelPsVue_PsVue_Tuk)) # don't meet assumptions, p-value < 2.2e-16
anova(ME_DelPsVue_PsVue_Tuk)

```
Plots looking at astrocyte contact and survival

```{r}


DelPsVue_PsVueViolinPlotAstro <- ggplot(SpinePsVueData2, aes(x=Astrocyte_contact, y=DelPsVue_PsVue)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SpinePsVueData2, aes(x = Astrocyte_contact, y = DelPsVue_PsVue, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpinePsVueData_animal_astro, aes(x = Astrocyte_contact, y = DelPsVue_PsVue, colour = Animal_ID), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("PtSer change 2h 
  post-treatment (Del PsVue  / PsVue )")))) +
  guides(colour = "none") +
  facet_wrap(~AbetaTreatment)
DelPsVue_PsVueViolinPlotAstro 
 
  ggsave(filename = "DelPsVue_PsVueViolinPlotAstro.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
  
```

```{r}
ME_DelPsVue_PsVueAstro_Tuk <- lmer(DelPsVue_PsVue_Tuk ~ Astrocyte_contact*AbetaTreatment+Sex+Brain_homogenate  +(1|Animal_ID/Slice_ID), data = SpinePsVueData2)
summary(ME_DelPsVue_PsVueAstro_Tuk)
resid_panel(ME_DelPsVue_PsVueAstro_Tuk) # residuals look ok
shapiro.test(resid(ME_DelPsVue_PsVueAstro_Tuk)) # don't meet assumptions W = 0.61873, p-value < 2.2e-16
anova(ME_DelPsVue_PsVueAstro_Tuk)
emmeans(ME_DelPsVue_PsVueAstro_Tuk, list(pairwise ~ Astrocyte_contact | AbetaTreatment), adjust = "tukey") #
emmeans(ME_DelPsVue_PsVueAstro_Tuk, list(pairwise ~  AbetaTreatment | Astrocyte_contact), adjust = "tukey") #
```


```{r}


DelPsVue_PsVueViolinPlotSurvival <- ggplot(SpinePsVueData2, aes(x=Survived_day2, y=DelPsVue_PsVue)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SpinePsVueData2, aes(x = Survived_day2, y = DelPsVue_PsVue, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpinePsVueData_animal_survival, aes(x = Survived_day2, y = DelPsVue_PsVue, colour = Animal_ID), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("PtSer change 2h 
  post-treatment (Del PsVue  / PsVue )")))) +
  guides(colour = "none") +
  facet_wrap(~AbetaTreatment)
DelPsVue_PsVueViolinPlotSurvival 
 
  ggsave(filename = "DelPsVue_PsVueViolinPlotSurvival.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
  
```
```{r}
ME_DelPsVue_PsVueSurv_Tuk <- lmer(DelPsVue_PsVue_Tuk ~ Survived_day2*AbetaTreatment+Sex+Brain_homogenate  +(1|Animal_ID/Slice_ID), data = SpinePsVueData2)
summary(ME_DelPsVue_PsVueSurv_Tuk)
resid_panel(ME_DelPsVue_PsVueSurv_Tuk) # residuals look ok
shapiro.test(resid(ME_DelPsVue_PsVueSurv_Tuk)) # don't meet assumptions W = 0.61873, p-value < 2.2e-16
anova(ME_DelPsVue_PsVueSurv_Tuk)
emmeans(ME_DelPsVue_PsVueSurv_Tuk, list(pairwise ~ Survived_day2 | AbetaTreatment), adjust = "tukey") #
emmeans(ME_DelPsVue_PsVueSurv_Tuk, list(pairwise ~  AbetaTreatment | Survived_day2), adjust = "tukey") #
```

------------------------
Survival plot in PsVue experiment
------------------------
```{r}

# import CSV
SurvData <- read.csv("Fig5Data_PsVue_survival.csv")

# assign factors to relevant variables and make exp date a real date

SurvData$Animal_ID <- as.factor(SurvData$Animal_ID)
SurvData$Slice_ID <- as.factor(SurvData$Slice_ID)
SurvData$AbetaTreatment <- as.factor(SurvData$Abeta)
SurvData$Astrocyte_contact <- as.factor(SurvData$Astrocyte_contact)
SurvData$Survival_probability <- as.numeric(SurvData$Survival_probability)

SurvData$AbetaTreatment <- recode(SurvData$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SurvData$Astrocyte_contact <- recode(SurvData$Astrocyte_contact, 'Y' = 'astrocyte contact',
                           'N'  = 'no astrocyte')


# remove rows without astrocyte data
SurvData <- SurvData[SurvData$Astrocyte_contact != "", ]
# get summary of event rate and change in event rate by animal
SurvData_animal <- SurvData %>%
    group_by(Animal_ID, AbetaTreatment) %>%
    summarize(Survival_probability=mean(Survival_probability))

SurvData_animal_astro <- SurvData %>%
    group_by(Animal_ID, AbetaTreatment, Astrocyte_contact) %>%
    summarize(Survival_probability=mean(Survival_probability))
```
```{r}

SurvViolinPlotSurv <- ggplot(SurvData, aes(x= Astrocyte_contact, y=Survival_probability)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SurvData, aes(x = Astrocyte_contact, y = Survival_probability, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SurvData_animal_astro, aes(x = Astrocyte_contact, y = Survival_probability, colour = Animal_ID), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Percent survived spines")))) +
  guides(colour = "none") +
  facet_wrap(~AbetaTreatment)
SurvViolinPlotSurv 
 
  ggsave(filename = "SurvPlotAstroPsVueExp.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )

  
ME_AstroSurv <- lmer(Survival_probability ~ Astrocyte_contact*AbetaTreatment+Sex +(1|Animal_ID/Slice_ID), data = SurvData)
summary(ME_AstroSurv)
resid_panel(ME_AstroSurv) # residuals look ok
shapiro.test(resid(ME_AstroSurv)) # don't meet assumptions W = 0.96089, p-value < 2.2e-16
anova(ME_AstroSurv)
emmeans(ME_AstroSurv, list(pairwise ~ Astrocyte_contact | AbetaTreatment), adjust = "tukey") #
```

------------------
Data for Fig 6
------------------
Analysis of spine activity with AD BRAIN HOMOGENATE and TBOA EAAT 1 - 2 inhibitor
------------------
```{r}
# import CSV
SpineTBOAData <- read.csv("Fig6Data_Activity_change_EEAT12_time_sex.csv")

SpineTBOAData$Animal_ID <- as.factor(SpineTBOAData$Animal_ID)
SpineTBOAData$Slice_ID <- as.factor(SpineTBOAData$Slice_ID)
SpineTBOAData$AbetaTreatment <- as.factor(SpineTBOAData$Abeta)
SpineTBOAData$Survived_day2 <- as.factor(SpineTBOAData$Survived_day2)
SpineTBOAData$Sex <- as.factor(SpineTBOAData$Sex)
SpineTBOAData$TBOA <- as.factor(SpineTBOAData$TBOA)
SpineTBOAData$EventRateHz <- SpineTBOAData$Hz
SpineTBOAData$TreatmentTime <- as.factor(SpineTBOAData$Time)


SpineTBOAData$AbetaTreatment <- recode(SpineTBOAData$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SpineTBOAData$Survived_day2 <- recode(SpineTBOAData$Survived_day2, 'Y' = 'Survived on day 2',
                           'N'  = 'Lost on day 2')

SpineTBOAData$TBOA <- recode(SpineTBOAData$TBOA, '+' = 'TBOA',
                           '-'  = 'vehicle')

SpineTBOAData$Astrocyte_contact <- recode(SpineTBOAData$Astrocyte_contact, 'Y' = 'Astrocyte contact',
                           'N'  = 'No astrocyte contact')

SpineTBOAData2 <- na.omit(SpineTBOAData) # removes NaNs
SpineTBOAData2 <- SpineTBOAData2[!is.na(SpineTBOAData2$TBOA) & SpineTBOAData2$TBOA != "" &
                                   !is.na(SpineTBOAData2$Astrocyte_contact) & SpineTBOAData2$Astrocyte_contact != "", ]
summary(SpineTBOAData2) 

```
```{r}
SpineTBOAData_animal <- SpineTBOAData2 %>%
    group_by(Animal_ID, AbetaTreatment, Astrocyte_contact, TBOA, TreatmentTime) %>%
    summarize(EventRateHz=mean(EventRateHz))

summary(SpineTBOAData_animal)
```
```{r}
EventRateTBOAPrePostViolinPlot <- ggplot(SpineTBOAData2, aes(TreatmentTime, EventRateHz)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
geom_violin(fill="transparent",draw_quantiles = 0.5) +
  geom_point(data = SpineTBOAData2, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpineTBOAData_animal, aes(x = TreatmentTime, y = EventRateHz, colour = Animal_ID), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.8, size = 2.5) +
  theme_classic(base_size = 14) + 
  xlab(NULL)  +
  theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
  ylab(expression(bold(paste("Spine calcium transient event rate (Hz)")))) +
  guides(colour = "none") +  # removes group legend
  facet_wrap(~ interaction(TBOA, AbetaTreatment), labeller = label_value, nrow=1)+theme(strip.text = element_text(size = 8))

EventRateTBOAPrePostViolinPlot 

``` 
```{r}
 
ME_EventRateHz <- lmer(EventRateHz ~ TreatmentTime*AbetaTreatment*TBOA +Sex
                    +(1|Animal_ID/Slice_ID), data = SpineTBOAData2)

summary(ME_EventRateHz)
resid_panel(ME_EventRateHz)
anova(ME_EventRateHz)
emmeans(ME_EventRateHz, pairwise ~ TreatmentTime | AbetaTreatment, by = "TBOA", adjust = "tukey")
emmeans(ME_EventRateHz, pairwise ~ TreatmentTime | TBOA , by = "AbetaTreatment", adjust = "tukey")
```
 
-------------
Change in activity by Survival with EAAT 1 2 inhibitor
-------------

```{r}
# import CSV
SpineTBOAData3 <- read.csv("Fig6Data_Activity_Change_EAAT12.csv")

SpineTBOAData3$Animal_ID <- as.factor(SpineTBOAData3$Animal_ID)
SpineTBOAData3$Slice_ID <- as.factor(SpineTBOAData3$Slice_ID)
SpineTBOAData3$AbetaTreatment <- as.factor(SpineTBOAData3$Abeta)
SpineTBOAData3$Survived_day2 <- as.factor(SpineTBOAData3$Survived_day2)
SpineTBOAData3$Sex <- as.factor(SpineTBOAData3$Sex)
SpineTBOAData3$TBOA <- as.factor(SpineTBOAData3$TBOA)
SpineTBOAData3$DelHzOverHz_ActivityChange <- SpineTBOAData3$DelHz_Hz

SpineTBOAData3$AbetaTreatment <- recode(SpineTBOAData3$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SpineTBOAData3$Survived_day2 <- recode(SpineTBOAData3$Survived_day2, 'Y' = 'Survived on day 2',
                           'N'  = 'Lost on day 2')

SpineTBOAData3$TBOA <- recode(SpineTBOAData3$TBOA, '+' = 'TBOA',
                           '-'  = 'vehicle')

SpineTBOAData3$Astrocyte_contact <- recode(SpineTBOAData3$Astrocyte_contact, 'Y' = 'Astrocyte contact',
                           'N'  = 'No astrocyte contact')

SpineTBOAData4 <- na.omit(SpineTBOAData3) # removes NaNs
SpineTBOAData4 <- SpineTBOAData4[!is.na(SpineTBOAData4$TBOA) & SpineTBOAData4$TBOA != "" &
                                   !is.na(SpineTBOAData4$Astrocyte_contact) & SpineTBOAData4$Astrocyte_contact != "" &
                                   !is.na(SpineTBOAData4$Survived_day2) & SpineTBOAData4$Survived_day2 != ""  &
                                    is.finite(SpineTBOAData4$DelHzOverHz_ActivityChange) & !is.na(SpineTBOAData4$DelHzOverHz_ActivityChange), ]


SpineTBOAData4_animal <- SpineTBOAData4 %>%
    group_by(Animal_ID, AbetaTreatment) %>%
    summarize(              DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))

```
```{r}
library(RColorBrewer)

SpineTBOAData4_animal_survival <- SpineTBOAData4 %>%
    group_by(Animal_ID, AbetaTreatment, Survived_day2, Sex) %>%
    summarize(DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))

color_values <- c(  "#1f77b4","#ff7f0e","#2ca02c","#d62728","#9467bd","#8c564b",
  "#e377c2","#7f7f7f","#bcbd22","#17becf",
  "#393b79","#637939","#8c6d31","#843c39","#7b4173",
  "#3182bd","#e6550d","#31a354","#756bb1","#636363",
  "#6baed6","#fd8d3c","#74c476","#9e9ac8","#969696",
  "#084594","#993404","#006d2c","#54278f","#252525",
  "#e41a1c","#377eb8","#4daf4a","#984ea3","#ff7f00","#ffff33")

DelHzOverHz_ACtivityChangeViolinPlotSurvTBOA <- ggplot(SpineTBOAData4, aes(x= Survived_day2, y=DelHzOverHz_ActivityChange)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SpineTBOAData4, aes(x = Survived_day2, y = DelHzOverHz_ActivityChange, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpineTBOAData4_animal_survival, aes(x = Survived_day2, y = DelHzOverHz_ActivityChange, colour = Animal_ID, shape=Sex), position = position_jitter(w = 0.3, h =   0.0), alpha = 0.8, size = 2.5, stroke=1)+ scale_color_manual(values=color_values)+
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Spine calcium transient change 2h 
  post-treatment (Del Hz post / Hz )")))) +
  guides(colour = "none") +
  facet_wrap(~ interaction(TBOA, AbetaTreatment), labeller = label_value, nrow=1)+theme(strip.text = element_text(size = 8))
 DelHzOverHz_ACtivityChangeViolinPlotSurvTBOA 
 
  ggsave(filename = "DelHzOverHz_ACtivityChangeViolinPlotSurvTBOA.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
```
```{r}
SpineTBOAData4$DelHzOverHz_ActivityChangeTuk <- transformTukey(SpineTBOAData4$DelHzOverHz_ActivityChange)

ME_DelHzOverHz_ActivityChange_Surv_TBOA_Tuk <- lmer(DelHzOverHz_ActivityChange ~ Survived_day2*AbetaTreatment*TBOA + Sex +(1|Animal_ID/Slice_ID), data = SpineTBOAData4)

summary(ME_DelHzOverHz_ActivityChange_Surv_TBOA_Tuk)
shapiro.test(resid(ME_DelHzOverHz_ActivityChange_Surv_TBOA_Tuk)) # don't meet assumptions W = 0.55162, p-value < 2.2e-16
anova(ME_DelHzOverHz_ActivityChange_Surv_TBOA_Tuk)
emmeans(ME_DelHzOverHz_ActivityChange_Surv_TBOA_Tuk, list(pairwise ~ Survived_day2 | AbetaTreatment ), by= "TBOA", adjust = "tukey")
```

----------------
Change in activity by astrocyte with EAAT 1 2 inhibitor
----------------

```{r}
SpineTBOAData4_animal_astro <- SpineTBOAData4 %>%
    group_by(Animal_ID, AbetaTreatment, Astrocyte_contact, TBOA, Sex) %>%
    summarize(          DelHzOverHz_ActivityChange=mean(DelHzOverHz_ActivityChange))


DelHzOverHz_ACtivityChangeViolinPlotAstroTBOA <- ggplot(SpineTBOAData4, aes(x=AbetaTreatment, y=DelHzOverHz_ActivityChange)) +
 geom_violin(draw_quantiles = c(0.25, 0.75),
  linetype = "dashed") +
 geom_violin(fill="transparent",draw_quantiles = 0.5) +
 geom_point(data = SpineTBOAData4, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2, size = 0.5) +
   geom_point(data = SpineTBOAData4_animal_astro, aes(x = AbetaTreatment, y = DelHzOverHz_ActivityChange, colour = Animal_ID, shape=Sex), position = position_jitter(w = 0.1, h =   0.0), alpha = 0.6, size = 2.5) +
  geom_hline(yintercept = 0, linetype = "dotted", color = "grey", size = 1) +  # Add horizontal dotted line
  theme_classic(base_size = 14) + 
#  ylim(0,6)+
  xlab(NULL)  +
   theme(
    axis.text.x = element_text(hjust = 0.5, vjust = -0.15, size = 15.0, face = "bold"),
    plot.margin = margin(t = 10, r = 10, b = 10, l = 30)  # Adjust left margin here
  ) +
  ylab(expression(bold(paste("Spine calcium transient change 2h 
  post-treatment (Del Hz  / Hz )")))) +
  guides(colour = "none") +
  facet_wrap(~ interaction(TBOA, Astrocyte_contact), labeller =  label_value, nrow=1)+theme(strip.text = element_text(size = 8))
 DelHzOverHz_ACtivityChangeViolinPlotAstroTBOA 
 
  ggsave(filename = "DelHzOverHz_ACtivityChangeViolinPlotAstroTBOA.png",
       width = 10,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
```

```{r}
ME_DelHzOverHz_ActivityChange_Astro_TBOA_Tuk <- lmer(DelHzOverHz_ActivityChangeTuk ~ Astrocyte_contact*AbetaTreatment*TBOA +Sex  +(1|Animal_ID/Slice_ID), data = SpineTBOAData4)
summary(ME_DelHzOverHz_ActivityChange_Astro_TBOA_Tuk)
shapiro.test(resid(ME_DelHzOverHz_ActivityChange_Astro_TBOA_Tuk)) # don't meet assumptions W = 0.55162, p-value < 2.2e-16
anova(ME_DelHzOverHz_ActivityChange_Astro_TBOA_Tuk)
emmeans(ME_DelHzOverHz_ActivityChange_Astro_TBOA_Tuk, list(pairwise ~ Astrocyte_contact | AbetaTreatment ), by= "TBOA", adjust = "tukey")
```

--------------------
Data for Fig 7
--------------------
Spine Survival by astrocyte with EAAT 1 2 inhibitor
--------------------

```{r}
# import CSV
SurvivalDataTBOA <- read.csv("Fig7Data_Survival_TBOA.csv")

SurvivalDataTBOA$Animal_ID <- as.factor(SurvivalDataTBOA$Animal_ID)
SurvivalDataTBOA$Slice_ID <- as.factor(SurvivalDataTBOA$Slice_ID)
SurvivalDataTBOA$AbetaTreatment <- as.factor(SurvivalDataTBOA$Abeta)
SurvivalDataTBOA$Astrocyte_contact <- as.factor(SurvivalDataTBOA$Astrocyte_contact)
SurvivalDataTBOA$Survival_Probability <- SurvivalDataTBOA$Survival_probability
SurvivalDataTBOA$Sex <- as.factor(SurvivalDataTBOA$Sex)
SurvivalDataTBOA$TBOA <- as.factor(SurvivalDataTBOA$TBOA)

SurvivalDataTBOA$AbetaTreatment <- recode(SurvivalDataTBOA$AbetaTreatment, '+' = 'Ab+ homogenate',
                           '-'  = 'Ab- homogenate')

SurvivalDataTBOA$Astrocyte_contact <- recode(SurvivalDataTBOA$Astrocyte_contact, 'Y' = 'astrocyte contact',
                           'N'  = 'no astrocyte')

SurvivalDataTBOA$Spine_ID <- paste(SurvivalDataTBOA$Slice_ID, SurvivalDataTBOA$AbetaTreatment, SurvivalData2$ROI)
SurvivalDataTBOA$Spine_ID <- as.factor(SurvivalDataTBOA$Spine_ID)

SurvivalDataTBOA$TBOA <- recode(SurvivalDataTBOA$TBOA, '+' = 'TBOA',
                           '-'  = 'vehicle')

SurvivalDataTBOA2 <- na.omit(SurvivalDataTBOA) # removes NaNs

```
```{r}
SurvivalDataTBOA2_animal <- SurvivalDataTBOA2 %>%
  group_by(Animal_ID, AbetaTreatment, Astrocyte_contact,TBOA,Sex) %>%
    summarize(          Survival_Probability=mean(Survival_Probability))
```
```{r}
SurvivalViolinPlotTBOA <- ggplot(SurvivalDataTBOA2, aes(y=Survival_Probability, x=Astrocyte_contact)) +
  geom_violin(draw_quantiles = c(0.25, 0.75),  linetype = "dashed") +  
  geom_violin(fill="transparent",draw_quantiles = 0.5) +
  geom_point(data = SurvivalDataTBOA2, aes(x = Astrocyte_contact, y = Survival_Probability, colour = Animal_ID), position = position_jitter(w = 0.05, h =   0.0), alpha = 0.2,      size = 0.5) +
  geom_point(data = SurvivalDataTBOA2_animal, aes(x = Astrocyte_contact, y = Survival_Probability, colour = Animal_ID,shape=Sex), position = position_jitter(w = 0.1, h =          0.0), alpha = 0.8, size = 2.5) +
  theme_classic(base_size = 14) + 
  xlab(NULL)  +
  theme(axis.text.x = element_text(hjust=0.5, vjust = -0.15, size = 15.0, face = "bold")) + 
  ylab(expression(bold(paste("Spine calcium transient event rate (Hz)")))) +
  guides(colour = "none") +  # removes group legend
  facet_wrap(~ interaction(AbetaTreatment, TBOA), labeller = label_both, nrow=2)

SurvivalViolinPlotTBOA

ggsave(filename = "Survival_ViolinPlot_TBOA.png",
       width = 8,
       height = 6,
       dpi = 600,
       limitsize = FALSE
       )
```

```{r}
ME_Survival_TBOA <- lmer(Survival_Probability ~ Astrocyte_contact*AbetaTreatment*TBOA + Sex  +(1|Animal_ID/Slice_ID), data = SurvivalDataTBOA2)

summary(ME_Survival_TBOA)
anova(ME_Survival_TBOA)
emmeans(ME_Survival_TBOA, list(pairwise ~  Astrocyte_contact | AbetaTreatment), by='TBOA', adjust = "tukey") #
```

